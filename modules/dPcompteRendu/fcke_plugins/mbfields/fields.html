<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-15" />
    <script type="text/javascript" src="../../../../lib/scriptaculous/lib/prototype.js"></script>
    <script type="text/javascript">
      var dialog = window.parent ;
      dialog.document.getElementById("btnCancel").value = "Fermer";
      var oEditor = dialog.InnerDialogLoaded() ;
      var FCK = oEditor.FCK;
      var FCKTools  = oEditor.FCKTools ;
      var FCKConfig = oEditor.FCKConfig ;
      var FCKBrowserInfo = oEditor.FCKBrowserInfo ;
      var fields = window.parent.parent.fields[0].options;

      // Au chargement, on initialise la liste déroulante avec les sections
      window.onload = function () {
        dialog.SetAutoSize( true ) ;
        var section = $("section");
        $H(fields).each(function(item, iterator){
          if (item.key != "AddItem" && item.key != "IndexOf")
          section.insert("<option value='" + item.key + "'>"+ item.key + "</option>");
        });
        section.selectedIndex = -1;
      }

      function reloadItem(section) {
        oItem = $("item");
        oItem.update();
        // Rien à faire si la section est vide
        if (section == '') return; 
        // On vide la section des sous-items
        reloadSubItem('');

        var items = fields[replaceEntites(section)];
        for (var item in items) {
          if (item == "AddItem" || item == "IndexOf") continue;
          var several_items = "";
          var tag = item;
          if (items[item].length != undefined) {
            several_items = " &gt;";
          } else {
            tag = items[item].view;
          }
          oItem.insert("<option value='" + item + "'>" + tag + several_items + "</option>");
        }
        oItem.selectedIndex = -1;
      }
    
      function reloadSubItem(section, item) {
        oSubItem = $("subitem");
        oSubItem.update();
  
        // Rien à faire si l'item est vide
        if (item == null) return;
        
        // Ne rien faire si l'item contient un tiret (ce sera sur un double clic qu'il sera inséré)
        if (item.indexOf("-") != -1) return;

        // Sinon insertion des sous-items
        subItems = fields[replaceEntites(section)][replaceEntites(item)];

        for(var subItem in subItems) {
          if (typeof subItems[subItem] == "function") continue;
          oSubItem.insert("<option value='" + subItem + "'>" + subItems[subItem].view + "</option>");
        }
        oSubItem.selectedIndex = -1;
      }

      function insertItem(section, item) {
				// Si le champ existe, alors on l'insère
        if (fields[replaceEntites(section)][replaceEntites(item)].item != null)
          insertHTML(fields[replaceEntites(section)][replaceEntites(item)].item);
      }
      
      function insertSubItem(section, item, subitem){
        if (fields[replaceEntites(section)][replaceEntites(item)][replaceEntites(subitem)].item != null)
          insertHTML(fields[replaceEntites(section)][replaceEntites(item)][replaceEntites(subitem)].item);
	    }

      function insertHTML(string) {
        // Before doing anything, save undo snapshot.
        oEditor.FCKUndo.SaveUndoStep() ;
  
        var sHtml ;
        sHtml = "<span class='field'>" + string + "</span>&nbsp;";
        sHtml = FCKTools.ProcessLineBreaks( oEditor, FCKConfig, sHtml ) ;
        oEditor.FCK.InsertHtml( sHtml ) ;
        dialog.document.getElementById("btnCancel").onclick();
        return true ;
      }
      
      function replaceEntites(string) {
        var replaceString = string.replace(/é/g, "&eacute;");
        replaceString = replaceString.replace(/è/g, "&egrave;");
        replaceString = replaceString.replace(/à/g, "&agrave;");
        replaceString = replaceString.replace(/â/g, "&acirc;");
        replaceString = replaceString.replace(/'/g, "&#039;");
        replaceString = replaceString.replace(/ô/g, "&ocirc;");
        return replaceString;
      }
    </script>

  </head>
  <body>
    <table>
      <tr>
        <td>
          <select id="section" onchange = "reloadItem(this.value)" size="10" style="width: 150px; height: 180px;">
          </select>
        </td>
        <td>
          <select id="item" onchange="reloadSubItem($('section').value, this.value);" ondblclick="insertItem($('section').value,this.value);" size="10" style="width: 205px; height: 180px;">
            <option value="">&mdash; Choisissez un item</option>
          </select>
        </td>
        <td>
          <select id="subitem" size="10" style="width: 170px; height: 180px;" ondblclick="insertSubItem($('section').value, $('item').value, this.value);">
            <option value="">&mdash; Choisissez un sous-item</option>
          </select>
        </td>  
      </tr>
    </table>
  </body>
</html>
