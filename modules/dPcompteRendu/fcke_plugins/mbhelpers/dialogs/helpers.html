<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <script type="text/javascript" src="../../../../../lib/scriptaculous/lib/prototype.js"></script>
  <script type="text/javascript">
    var CKEDITOR = window.parent.parent.CKEDITOR;
    var arrayHelperIndex = [];
    var arrayHelperStyle = [];
    var arrayHelperContent = [];
    var noHelpers = 0;
    if (window.parent.parent.helpers[0] != null)
      helpers = window.parent.parent.helpers[0].options;

    // Au chargement, on initialise la liste déroulante avec les aide à la saisie
    window.onload = function () {
      var list = $("helper");
      var i = 0;
      
      $H(helpers).each(function(category, iterator){
        if (category.value.length == 0) {
          noHelpers ++;
        }
        if (typeof category.value != "function") {
          for(var helper in category.value) {
            if (typeof category.value[helper] != "function") {
              var style="";
              if (category.key.indexOf("utilisateur") != -1)
                style = "url(../../../../../images/icons/user.png) no-repeat";
              else if (category.key.indexOf("fonction") != -1)
                style = "url(../../../../../images/icons/user-function.png) no-repeat";
              else
                style = "url(../../../../../images/icons/group.png) no-repeat";
              arrayHelperIndex[i] = helper;
              arrayHelperStyle[i] = style;
              arrayHelperContent[i] = category.value[helper]; 
              i++;
            }
          }
        }
      });
      if (noHelpers == 3)
        list.insert("<option value='0'>Aucune aide à la saisie</option>");
      else
        arrayHelperIndex.each(function(item, iterator) {
          list.insert("<option value='" + iterator + "'>" + item + "</option>");
        });
      list.selectedIndex = -1;
    }

    function insertHTML(index){
      var string = arrayHelperContent[index];
      var sHtml = "<span class='field'>" + string.replace(/\n/g, "<br/>") + "</span>&nbsp;";
      CKEDITOR.instances.htmlarea.focus();
      if (CKEDITOR.env.gecko) {
        insertSpecialChar(sHtml);
      } else {
        CKEDITOR.instances.htmlarea.insertHtml(sHtml);
      }
      CKEDITOR.dialog.getCurrent().hide();
      CKEDITOR.instances.htmlarea.fire("key", []);
      return true ;
    }
    
    function previewHelper(helper) {
      $("preview").innerHTML = (arrayHelperContent[helper]).replace(/\n/g, "<br/>");
      $("category_helper").setStyle({background: arrayHelperStyle[helper]});
    }
		
    function insertSpecialChar(specialChar) { 
      var selection = CKEDITOR.instances.htmlarea.getSelection(), 
          ranges    = selection.getRanges(), 
          range, textNode;  
       
      for ( var i = 0, len = ranges.length ; i < len ; i++ ) { 
        range = ranges[ i ]; 
        range.deleteContents(); 
        textNode = CKEDITOR.dom.element.createFromHtml( specialChar ); 
        range.insertNode( textNode ); 
      } 
       
      range.moveToPosition( textNode, CKEDITOR.POSITION_AFTER_END ); 
      range.select(); 
    }
  </script>

</head>
<body>
  <table>
    <tr>
      <td>
        <select id="helper" size="10" style="width: 200px; height: 180px;" onchange="if (noHelpers != 3) previewHelper(this.value);"
                ondblclick="if (noHelpers != 3) insertHTML(this.value)">
        </select>
      </td>
      <td style="vertical-align: top;">
        <div id="category_helper" style="width: 16px; height: 16px;"></div>
        <div id="preview" style="overflow: auto; max-height: 180px;"></div>
      </td>
    </tr>
  </table>
</body>
</html>
