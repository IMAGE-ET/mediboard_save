<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
    <script type="text/javascript" src="../../../../../lib/scriptaculous/lib/prototype.js"></script>
    <script type="text/javascript">
      var fields = window.parent.parent.fields[0].options;
      var CKEDITOR = window.parent.parent.CKEDITOR;
      
      // Au chargement, on initialise la liste déroulante avec les sections
      window.onload = function () {
        var section = $("section");
        $A(fields).each(function(item, i){
          var sItem = item[0]; var iter = 1;
          while (sItem.length != "undefined" && iter < sItem.length) {
            sItem = item[iter]; iter++;
          }
          section.insert("<option value='" + i + "'>"+ sItem.section + "</option>");
        });
        section.selectedIndex = -1;
      }

      function reloadItem(section) {
        var oItem = $("item").update();

        // Rien à faire si la section est vide
        if (section == '') return; 
        // On vide la section des sous-items
        reloadSubItem('');

        var items = fields[section];
        for (var item in items) {
          if (typeof items[item] == "function") continue;
          var several_items = "";
          var tag = '';
          if (items[item].length != undefined) {
            several_items = " &gt;";
            tag = items[item][0].itemname;
          } else {
            tag = items[item].view;
          }
          oItem.insert("<option value='" + item + "'>" + tag + several_items + "</option>");
        }
        oItem.selectedIndex = -1;
      }
    
      function reloadSubItem(section, item) {
        var oSubItem = $("subitem").update();
  
        // Rien à faire si l'item est vide
        if (item == null) return;
          subItems = fields[section][item];

        // Ne rien faire si l'attribut length est undefined (ce n'est pas un tableau, donc pas de sous-items)
        if (subItems.length == undefined) return;

        // Sinon insertion des sous-items
        for(var subItem in subItems) {
          if (typeof subItems[subItem] == "function") continue;
          oSubItem.insert("<option value='" + subItem + "'>" + subItems[subItem].view + "</option>");
        }
        oSubItem.selectedIndex = -1;
      }

      function insertItem(section, item) {
        // Si le champ existe, alors on l'insère
        if (fields[section][item].item != null)
          insertHTML(fields[section][item].item);
      }
      
      function insertSubItem(section, item, subitem){
        if (fields[section][item][subitem].item != null)
          insertHTML(fields[section][item][subitem].item);
      }

      function insertHTML(string) {
        //var sHtml = "<span class='field' contenteditable='false'>" + string + "</span>&nbsp;";
        var sHtml = "<span class='field'>" + string + "</span>&nbsp;";
        CKEDITOR.instances.htmlarea.insertHtml(sHtml);
        CKEDITOR.dialog.getCurrent().hide();
        CKEDITOR.instances.htmlarea.fire("key", []);
        return true ;
      }

    </script>

  </head>
  <body>
    <table>
      <tr>
        <td>
          <select id="section" onchange = "reloadItem(this.value)" size="10" style="width: 150px; height: 180px;">
          </select>
        </td>
        <td>
          <select id="item" onchange="reloadSubItem($('section').value, this.value);" ondblclick="insertItem($('section').value,this.value);" size="10" style="width: 205px; height: 180px;">
            <option value="">&mdash; Choisissez un item</option>
          </select>
        </td>
        <td>
          <select id="subitem" size="10" style="width: 170px; height: 180px;" ondblclick="insertSubItem($('section').value, $('item').value, this.value);">
            <option value="">&mdash; Choisissez un sous-item</option>
          </select>
        </td>  
      </tr>
    </table>
  </body>
</html>